cmake_minimum_required (VERSION 2.8.12)
project (QMLRemoteTransmission)
set (TARGET RemoteTransmission)
set (${TARGET}_VERSION_MAJOR 0)
set (${TARGET}_VERSION_MINOR 1)
set (${TARGET}_VERSION ${${TARGET}_VERSION_MAJOR}.${${TARGET}_VERSION_MINOR})

add_definitions (-DURI="${TARGET}")
add_definitions (-DVERSION_MAJOR=${${TARGET}_VERSION_MAJOR})
add_definitions (-DVERSION_MINOR=${${TARGET}_VERSION_MINOR})

find_package (Qt5Core)
find_package (Qt5Qml)
find_package (Qt5Quick)

list (APPEND CMAKE_MODULE_PATH 0 "${CMAKE_CURRENT_SOURCE_DIR}/cmake")
include (FindQmlPluginDump)
include (FindQmlImportPath)

set (CMAKE_AUTOMOC ON)
set (CMAKE_AUTORCC ON)

add_subdirectory (3rdparty/libremotetransmission EXCLUDE_FROM_ALL)
include_directories ("${PROJECT_SOURCE_DIR}/3rdparty/libremotetransmission/pub")

## QML FILES ##
file (GLOB_RECURSE QML_FILES "${CMAKE_CURRENT_SOURCE_DIR}/qml/*.qml")
add_custom_target (qml_files SOURCES ${QML_FILES})

## QMLDIR FILE ##
set (QMLDIR "${CMAKE_CURRENT_BINARY_DIR}/${TARGET}/qmldir")

## QMLTYPES FILE (autogenerated) ##
set (QMLTYPES_FILE "remotetransmission.qmltypes")
set (QMLTYPES "${CMAKE_CURRENT_BINARY_DIR}/${TARGET}/${QMLTYPES_FILE}")

## SOURCES ##
aux_source_directory ("${CMAKE_CURRENT_SOURCE_DIR}/src" RemoteTransmissionSources)

add_library (${TARGET} MODULE
    ${RemoteTransmissionSources}
    "${CMAKE_CURRENT_SOURCE_DIR}/qml/qml.qrc"
)
set_target_properties (${TARGET} PROPERTIES LIBRARY_OUTPUT_DIRECTORY ${TARGET})
target_link_libraries (${TARGET} rt Qt5::Core Qt5::Quick Qt5::Qml)

configure_file(
    "${CMAKE_CURRENT_SOURCE_DIR}/src/qmldir.in"
    ${QMLDIR} @ONLY NEWLINE_STYLE UNIX
)
add_custom_command (
    TARGET ${TARGET} POST_BUILD
    COMMAND ${QMLPLUGINDUMP_COMMAND}
    ${TARGET} ${${TARGET}_VERSION} ${CMAKE_CURRENT_BINARY_DIR} > ${QMLTYPES}
)
install (TARGETS ${TARGET}   DESTINATION ${QT_INSTALL_QML}/${TARGET}/)
install (FILES   ${QMLDIR}   DESTINATION ${QT_INSTALL_QML}/${TARGET}/)
install (FILES   ${QMLTYPES} DESTINATION ${QT_INSTALL_QML}/${TARGET}/)
